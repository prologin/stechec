<?php
/*

    ACU Intranet project is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation; either version 2 of the License, or
    (at your option) any later version.

    ACU Intranet project is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with the ACU Intranet project; if not, write to the Free Software
    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

    Copyright ACU EPITA Promo 2004-2005

	* Becoulet Alexandre <becoul_a@epita.fr>
	* Bizon Maxime <bizon_m@epita.fr>
        * Hesling Fabrice <fabecc@epita.fr>

*/

include "include/sondage.php";

function votes_disp($sid)
{
  global $_action;
  global $_entry;
  global $user_profil;

  /* donnees sur le sondage */
  $res = db_query("SELECT createur, promo, statut, @nc:=nb_choix, ".
		  "       titre, question ".
		  "FROM sondage ".
		  "WHERE sondage.id=".$sid,
		  $db_link);

  if (db_num_rows($res) < 1)
    return;

  $snd = db_fetch_row($res);

  /* nombre de votes laisses par l'utilisateur */
  $ucnt = db_fetch_row(db_query("SELECT @uc:=COUNT(*) FROM sondage_votes ".
			       "WHERE voter_id=".$user_profil["id"]." ".
			       "AND   sondage_id=".$sid,
			       $db_link));

  /* droit de vote ? */
  // new delex : rajoute view_answers
  $acl_vote = ($snd[1] == $user_profil[promo] &&
	       ($snd[2] == SND_ST_ENCOUR || $snd[2] == SND_ST_ONLY_ASSIST || $snd[2] == SND_ST_VIEW_ANSWERS)) ? ACL_ALL : 0;

  switch ($_action)
    {
    case "flush":

      if (!access_check(ACL_SITEADM))
	break;

      db_query("DELETE FROM sondage_votes WHERE prop_id=".$_entry, $db_link);

      break;

    case "dec":

      if (!access_check(ACL_SITEADM))
	break;

      db_query("DELETE FROM sondage_votes WHERE prop_id=".$_entry." LIMIT 1", $db_link);

      break;

    case "inc":

      if (!access_check(ACL_SITEADM))
	break;

      db_query("INSERT INTO sondage_votes (prop_id, voter_id, sondage_id) ".
	       "SELECT ".$_entry.", user_prof.id, ".$sid." ".
	       "FROM user_prof WHERE user_prof.promo=".$snd[1]." ".
	       "AND user_prof.statut<2 AND user_prof.id_profil=1 ".
	       "ORDER BY RAND() LIMIT 1",
	       $db_link);

      break;

    case "unvote":

      if (!access_check($acl_vote))
	break;

      db_query("DELETE FROM sondage_votes WHERE voter_id=".$user_profil[id]." ".
	       "AND   prop_id=".$_entry." LIMIT 1", $db_link);
      db_query("DO @uc:=GREATEST(@uc-1, 0)");

      break;

    case "vote":

      if (!access_check($acl_vote))
	break;

      /* check max vote count */
      if ($ucnt[0] >= $snd[3])
	break;

      db_query("INSERT INTO sondage_votes (prop_id, voter_id, sondage_id) ".
	       "VALUES (".$_entry.", ".$user_profil[id].", ".$sid.")", $db_link);
      db_query("DO @uc:=@uc+1");

      break;
    }

  db_query("DO @i:=1, @last:=100000");

  /* nombre de votes de la proposition la plus haute et total de votes */
  db_query("SELECT @votes:=GREATEST(MAX(t.count), 1), @total:=SUM(t.count) ".
	   "FROM (SELECT COUNT(*) AS count FROM sondage_votes ".
	   "WHERE sondage_votes.sondage_id=".$sid." ".
	   "GROUP BY sondage_votes.prop_id) AS t",
	   $db_link);

  /* taux de participation */
  $part = db_fetch_row(db_query("SELECT TRUNCATE((@total*100)/(COUNT(*)*@nc), 2) ".
				"FROM user_prof WHERE promo=".$snd[1]." ".
				"AND statut<2", $db_link));

  $res = db_query(
		  /* calcul du classement */
		  "SELECT IF(@last>FLOOR(t.votes), @rank:=@i, @rank) AS rank, t.uvotes, ".
		  "@i:=@i+1, @last:=FLOOR(t.votes) AS votes, IF(@uc<@nc, t.id, '') AS vid, ".
		  "IF(t.uvotes, t.id, '') AS rid, t.id, t.proposition, t.pvotes ".

		  "FROM (SELECT sondage_props.id, sondage_props.proposition, ".
		  /* nombre de votes */
		  "IF(sondage_votes.voter_id, COUNT(*), 0) AS votes, ".
		  /* delex */
		  "42 AS tmp, ".
		  "sondage_props.answers_max AS an, ".
		  /* % de votes par rapport au max */
		  "FLOOR(IF(sondage_votes.voter_id, COUNT(*), 0)*100/@votes)+1 AS pvotes, ".
		  /* nombre de vote personnels */
		  "IF(sondage_votes.voter_id, SUM(sondage_votes.voter_id=".$user_profil["id"]."), 0) AS uvotes ".

		  "FROM sondage_props LEFT JOIN sondage_votes ".
		  "ON sondage_votes.prop_id=sondage_props.id ".
		  "WHERE sondage_props.sondage_id=".$sid." ".
		  "GROUP BY sondage_props.id ORDER BY votes DESC, proposition) AS t", $db_link);

  style_title("Sondage ".$snd[4]);

  style_text("<b>Question: </b>".$snd[5]."<br>");

  if (($snd[3] > 1) && access_check($acl_vote))
    style_text("Vous avez droit a <b>".$snd[3]."</b> votes pour ce sondage.<br>");

  style_text("Le taux de participation a ce sondage est de <b>".$part[0]."%</b>.<p>");

  // on ne peut voir les resultats que si c'est un view_answer
  if ($snd[2] == SND_ST_VIEW_ANSWERS) {
    style_links(array(
		    array("Voir les resultats", ACL_ALL,
			  array("_id_page" => 244))
		    ));
  }




  $list = array(
		array("rank",		"Rank",	"text", ACL_ALL,
		      0, array("center")),
		array("proposition",	"Proposition",	"text", ACL_ALL),
		array("votes",		"Votes",	"text", ACL_ALL,
		      0, array("center")),
		array("uvotes",		"Perso",	"text", ACL_ALL,
		      0, array("center")),
		/* fixme delex */
		array("ans_max",	"answers max",	"text", ACL_ALL,
		      0, array("center")),
		/* end fixme */
		array("pvotes",		"",		"percent", ACL_ALL,
		      0, array("pbar")),
		array("vid",		"Voter",	"link", $acl_vote,
		      array("_action" => "vote"), array("center")),
		array("rid",		"Retirer",	"link", $acl_vote,
		      array("_action" => "unvote"), array("center")),
		array("id",		"Zero",		"link", ACL_SITEADM,
		      array("_action" => "flush"), array("center")),
		array("id",		"Moins",	"link", ACL_SITEADM,
		      array("_action" => "dec"), array("center")),
		array("id",		"Plus",		"link", ACL_SITEADM,
		      array("_action" => "inc"), array("center")),
		);

  list_disp($res, $list, array("gray", "bluegray"), "even");
}

$post_data["_promo"] = intval($_promo);

votes_disp($_info_id);

?>

